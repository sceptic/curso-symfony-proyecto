<?php

namespace Animales\CatalogoBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\Common\Cache\ApcCache;
use Doctrine\ORM\Query\ResultSetMapping;
/**
 * SubCategoryRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SubCategoryRepository extends EntityRepository
{

//1: findSubCategoryProducts
	/**
	 * Encuentra todos los productos de una subcategoria
	 */
	public function findSubCategoryProducts($slug){
		$em = $this->getEntityManager();
		$dql =  'SELECT s,p,i,
						c.name, c.slug
                 FROM AnimalesCatalogoBundle:SubCategory s
                 JOIN s.products p
                 JOIN s.category c
                 JOIN p.image i
                 WHERE s.slug = :slug';

        $query = $em->createQuery($dql)
        			->setParameter('slug',$slug);

        $result= $query->useResultCache(true)->getArrayResult();
        $cacheDriver = new ApcCache();
		$cacheDriver->save('AllProducts'.$slug, $result); 
         
		return $result;
	}

// 2: findAllCategory
	/**
	 * Encontrar todas las subcategorias de una categoria con productos
	 */
	public function findAllCategory($slug){
		// slug categoria
		$em = $this->getEntityManager();
		$dql= 'SELECT  s,p,
						c.name, c.slug,
						COUNT(p.id) as number_products
                 FROM AnimalesCatalogoBundle:SubCategory s
                 LEFT JOIN s.products p
                 LEFT JOIN s.category c
                 WHERE c.slug = :slug GROUP BY s.id ORDER BY s.name ASC';

        $query = $em->createQuery($dql)
        			->setParameter('slug', $slug);

         $result= $query->useResultCache(true)->getArrayResult(); 

         if($result)
         {
        	$cacheDriver = new ApcCache();
			$cacheDriver->save('SubcategoriesProducts'.$slug, $result);
         	return $result;
         }else{

         	return $this->findAllCS($slug);
         }

	}

// 3: findAllCS
	/**
	 * Encontrar todas las subcategorias de una categoria
	 */
	public  function findAllCS($slug){
		// slug categoria
		$em = $this->getEntityManager();
		$dql= 'SELECT 
               c,s
               FROM 
               AnimalesCatalogoBundle:Category c
               LEFT JOIN c.subcategories s ';
        $dql.= "WHERE c.slug = :slug ORDER BY s.name ASC";


        $query = $em->createQuery($dql)
        			->setParameter('slug', $slug);

        $result= $query->useResultCache(true)->getArrayResult(); 
        $result= $query->useResultCache(true)->getArrayResult();
        $cacheDriver = new ApcCache();
		$cacheDriver->save('Subcategories'.$slug, $result);
        
		return $result;
	} 

// 4: filterProducts
    /**
     * Filtrado productos [Categoria / Subcategoria, ASC / DESC]
     */
    public  function filterProducts($category = null, $subcategory = null, $sort = null ){

        $em = $this->getEntityManager();

        $where = ' ';

        if( $category != null )
        {
            $where = 'WHERE c.id = :id';
            $param = $category;
        }

        if( $subcategory != null )
        {
            $where = 'WHERE s.id = :id';
            $param = $subcategory;
        }

        if( $sort != 'DESC' )
        {
            $sort = 'ASC';
        }
       
        $dql =  "SELECT p,i,s,c
                 FROM AnimalesCatalogoBundle:Product p
                 JOIN p.subcategory s
                 JOIN p.image i 
                 JOIN s.category c ";
        $dql.= $where;

        $dql.=   " ORDER BY p.id ".$sort;
        $query = $em->createQuery($dql);

        if(isset($param)) $query = $query->setParameter(':id', (int) $param );
        
        /*
        paginar:
          $query = $query->setMaxResults((int) $max);
          $query = $query->setFirstResult((int) $first);
        */

        $result= $query->getArrayResult();
        
        return $result;
    }




}
